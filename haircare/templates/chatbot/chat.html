{% extends 'core/base.html' %}
{% load static %}

{% block title %}Hair Care Assistant{% endblock %}

{% block content %}
<div class="container">
    <div class="chat-container">
        <div class="chat-header">
            <h2>üíá‚Äç‚ôÄÔ∏è Hair Care Assistant</h2>
            <p>Your personal AI expert for all things hair care!</p>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="message bot">
                <div class="message-content">
                    Hi! üëã I'm your hair care assistant. I can help you with questions about hair types, products, styling, treatments, scalp health, and more. What would you like to know about hair care today?
                </div>
            </div>
        </div>
        
        <div class="typing-indicator" id="typingIndicator">
            <span class="typing-dots">
                <span></span>
                <span></span>
                <span></span>
            </span>
            <span style="margin-left: 8px;">Assistant is typing...</span>
        </div>
        
        <div class="chat-input-area">
            <form class="chat-input-form" id="chatForm">
                <input 
                    type="text" 
                    id="messageInput" 
                    placeholder="Ask me about hair care..." 
                    autocomplete="off"
                    required
                >
                <button type="submit" id="sendButton">Send</button>
            </form>
        </div>
    </div>
</div>

<script>
    let sessionId = sessionStorage.getItem('chat_session_id');
    if (!sessionId) {
        sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        sessionStorage.setItem('chat_session_id', sessionId);
    }
    
    const chatMessages = document.getElementById('chatMessages');
    const chatForm = document.getElementById('chatForm');
    const messageInput = document.getElementById('messageInput');
    const typingIndicator = document.getElementById('typingIndicator');
    const sendButton = document.getElementById('sendButton');
    
    function addMessage(content, isUser) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'user' : 'bot'}`;
        messageDiv.innerHTML = `<div class="message-content">${escapeHtml(content)}</div>`;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = message;
        chatMessages.appendChild(errorDiv);
        setTimeout(() => errorDiv.remove(), 5000);
    }
    
    function setLoading(isLoading) {
        if (isLoading) {
            typingIndicator.classList.add('active');
            sendButton.disabled = true;
            messageInput.disabled = true;
        } else {
            typingIndicator.classList.remove('active');
            sendButton.disabled = false;
            messageInput.disabled = false;
            messageInput.focus();
        }
    }
    
    chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const message = messageInput.value.trim();
        if (!message) return;
        
        addMessage(message, true);
        messageInput.value = '';
        setLoading(true);
        
        try {
            const response = await fetch('/chatbot/api/chat/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: message, session_id: sessionId })
            });
            
            const data = await response.json();
            
            if (data.success) {
                addMessage(data.response, false);
            } else {
                showError(data.error || 'Sorry, something went wrong.');
            }
        } catch (error) {
            console.error('Error:', error);
            showError('Unable to connect. Please check your internet connection.');
        } finally {
            setLoading(false);
        }
    });
    
    messageInput.focus();
</script>
{% endblock %}